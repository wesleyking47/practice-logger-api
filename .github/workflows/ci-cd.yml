name: CI/CD

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.101

      - name: Restore
        run: dotnet restore PracticeLogger.sln

      - name: Build
        run: dotnet build PracticeLogger.sln --configuration Release --no-restore

      - name: Unit tests
        run: dotnet test --project tests/PracticeLogger.Tests.Unit/PracticeLogger.Tests.Unit.csproj --configuration Release --no-build

      - name: Integration tests
        run: dotnet test --project tests/PracticeLogger.Tests.Integration/PracticeLogger.Tests.Integration.csproj --configuration Release --no-build

  migrate:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_API_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Resolve API outputs
        id: api_outputs
        run: |
          set -euo pipefail
          API_FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiFunctionName'].OutputValue | [0]" \
            --output text)
          API_ENDPOINT=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiEndpoint'].OutputValue | [0]" \
            --output text)
          if [ -z "$API_FUNCTION_NAME" ] || [ "$API_FUNCTION_NAME" = "None" ]; then
            echo "ApiFunctionName output not found for stack ApiStack" >&2
            exit 1
          fi
          if [ -z "$API_ENDPOINT" ] || [ "$API_ENDPOINT" = "None" ]; then
            echo "ApiEndpoint output not found for stack ApiStack" >&2
            exit 1
          fi
          echo "function_name=$API_FUNCTION_NAME" >> "$GITHUB_OUTPUT"
          echo "api_endpoint=$API_ENDPOINT" >> "$GITHUB_OUTPUT"

      - name: Enable migrations flag
        run: |
          set -euo pipefail
          aws lambda get-function-configuration \
            --function-name "${{ steps.api_outputs.outputs.function_name }}" \
            --query "Environment.Variables" \
            --output json > env.json
          jq -c '{FunctionName: $fn, Environment: {Variables: (. + {RUN_MIGRATIONS:"true"})}}' \
            --arg fn "${{ steps.api_outputs.outputs.function_name }}" env.json > env-updated.json
          aws lambda update-function-configuration \
            --cli-input-json file://env-updated.json
          aws lambda wait function-updated \
            --function-name "${{ steps.api_outputs.outputs.function_name }}"

      - name: Trigger migrations via HTTP
        run: |
          set -euo pipefail
          for i in {1..10}; do
            if curl -fsS "${{ steps.api_outputs.outputs.api_endpoint }}/healthz" > /dev/null; then
              exit 0
            fi
            sleep 3
          done
          echo "API did not respond in time while running migrations" >&2
          exit 1

      - name: Disable migrations flag
        if: always()
        run: |
          set -euo pipefail
          aws lambda get-function-configuration \
            --function-name "${{ steps.api_outputs.outputs.function_name }}" \
            --query "Environment.Variables" \
            --output json > env.json
          jq -c '{FunctionName: $fn, Environment: {Variables: (. + {RUN_MIGRATIONS:"false"})}}' \
            --arg fn "${{ steps.api_outputs.outputs.function_name }}" env.json > env-updated.json
          aws lambda update-function-configuration \
            --cli-input-json file://env-updated.json

  deploy:
    runs-on: ubuntu-latest
    needs: migrate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.101

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_API_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish Lambda package
        run: dotnet publish src/PracticeLogger.Api/PracticeLogger.Api.csproj -c Release -o publish

      - name: Create zip artifact
        run: |
          cd publish
          zip -r ../api.zip .

      - name: Resolve API function name
        id: api_function
        run: |
          API_FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiFunctionName'].OutputValue | [0]" \
            --output text)
          if [ -z "$API_FUNCTION_NAME" ] || [ "$API_FUNCTION_NAME" = "None" ]; then
            echo "ApiFunctionName output not found for stack ApiStack" >&2
            exit 1
          fi
          echo "name=$API_FUNCTION_NAME" >> "$GITHUB_OUTPUT"

      - name: Update Lambda code
        run: |
          aws lambda update-function-code \
            --function-name "${{ steps.api_function.outputs.name }}" \
            --zip-file "fileb://api.zip"

      - name: Wait for Lambda update
        run: |
          aws lambda wait function-updated \
            --function-name "${{ steps.api_function.outputs.name }}"
