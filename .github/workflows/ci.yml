name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.101

      - name: Restore
        run: dotnet restore PracticeLogger.sln

      - name: Build
        run: dotnet build PracticeLogger.sln --configuration Release --no-restore

      - name: Unit tests
        run: dotnet test --project tests/PracticeLogger.Tests.Unit/PracticeLogger.Tests.Unit.csproj --configuration Release --no-build

      - name: Integration tests
        run: dotnet test --project tests/PracticeLogger.Tests.Integration/PracticeLogger.Tests.Integration.csproj --configuration Release --no-build

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.101

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_API_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Publish Lambda package
        run: dotnet publish src/PracticeLogger.Api/PracticeLogger.Api.csproj -c Release -o publish

      - name: Create zip artifact
        run: |
          cd publish
          zip -r ../api.zip .

      - name: Resolve API function name
        id: api_function
        run: |
          API_FUNCTION_NAME=$(aws cloudformation describe-stacks \
            --stack-name ApiStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiFunctionName'].OutputValue | [0]" \
            --output text)
          if [ -z "$API_FUNCTION_NAME" ] || [ "$API_FUNCTION_NAME" = "None" ]; then
            echo "ApiFunctionName output not found for stack ApiStack" >&2
            exit 1
          fi
          echo "name=$API_FUNCTION_NAME" >> "$GITHUB_OUTPUT"

      - name: Update Lambda code
        run: |
          aws lambda update-function-code \
            --function-name "${{ steps.api_function.outputs.name }}" \
            --zip-file "fileb://api.zip"

      - name: Wait for Lambda update
        run: |
          aws lambda wait function-updated \
            --function-name "${{ steps.api_function.outputs.name }}"
